# ReHLDS-M

**[English](https://github.com/hun1er/rehlds-m/blob/main/README.md)** | **Русский**

---

Rehlds-m — это современный, кроссплатформенный загрузчик для выделенного сервера Half-Life (HLDS), написанный с нуля на C++17. Он выступает в качестве замены стандартного исполняемого файла `hlds.exe`, обеспечивая повышенную производительность, стабильность и множество новых функций для администраторов серверов, сохраняя при этом полную совместимость с оригинальными библиотеками движка (`swds.dll` в Windows, `engine_i486.so` в Linux) и игровыми модами.

## Ключевые отличия от оригинального HLDS/ReHLDS

- **Современная кодовая база:** Проект написан на C++17 с использованием современных практик и стандартной библиотеки шаблонов (STL).
- **Производительность:** Скомпилирован для современных процессоров с поддержкой набора инструкций SSE4.2 для максимальной эффективности.
- **Улучшенная консоль:**
  - **Расширенный ввод:** Полная поддержка клавиш `HOME`, `END` и `DELETE` для упрощения редактирования команд.
  - **История команд:** Последние 100 команд сохраняются в `input_history.txt` и загружаются при запуске. Полностью поддерживается навигация с помощью стрелок.
  - **Улучшенная строка состояния (Windows):** Строка состояния сервера больше не привязана к первой строке и всегда видна на экране.
- **Полная поддержка UTF-8:** Обеспечивает корректное отображение всех символов без необходимости преобразования в OEM в Windows.
- **Новые режимы производительности:**
  - Добавлены уровни `-pingboost` 4 и 5 для более агрессивной настройки производительности как в Windows, так и в Linux.
  - Введен параметр `-targetfps` для адаптивного управления FPS в реальном времени.
- **Новые служебные параметры:**
  - `-conclearlog`: Очищает файл `qconsole.log` при запуске сервера.
  - `-ignoresigint`: Предотвращает завершение работы сервера по нажатию `CTRL+C`.
  - `-pidfile`: Сохраняет ID процесса сервера в указанный файл.
- **Стабильность:**
  - Исправлены некоторые баги, присутствующие в оригинальном ReHLDS.
  - Создание расширенных дампов памяти в Windows для облегчения диагностики сбоев.
  - Используется Winsock 2.2 в Windows (вместо 2.0).

## Требования

- **Операционная система:**
  - Windows 7 - 11 (x86)
  - Linux с Glibc 2.18 или выше (например, Debian 8+, CentOS 8+, Ubuntu 14+).
- **Процессор:** Современный процессор с поддержкой набора инструкций **SSE4.2**.
- **Зависимости (Windows):** Должен быть установлен [Microsoft Visual C++ Redistributable 2015-2022 (x86)](https://aka.ms/vs/17/release/vc_redist.x86.exe).

## Установка

1.  **Резервное копирование:** Сделайте резервную копию вашего оригинального исполняемого файла сервера (например, `hlds.exe` в Windows или `hlds_linux`/`hlds_run` в Linux).
2.  **Замена:** Скопируйте все файлы из архива с релизом в корневую директорию вашего сервера.
    -   Для **Windows** это включает `hlds.exe`.
    -   Для **Linux** это включает `hlds_linux` и несколько файлов библиотек (`lib*.so`). Убедитесь, что у исполняемого файла есть права на выполнение (`chmod +x hlds_linux`).
3.  **Запуск:** Запустите сервер с помощью нового исполняемого файла, как вы делаете это обычно, с любыми желаемыми параметрами командной строки.

## Параметры командной строки

Этот загрузчик поддерживает все стандартные параметры HLDS. Ниже приведены новые или значительно измененные параметры, представленные в rehlds-m.

### Настройка производительности

#### `-pingboost <уровень>`

Этот параметр регулирует политику "сна" сервера для контроля загрузки ЦП и FPS.

-   **`0`**: (По умолчанию) Стандартный сон на 1 мс. Минимальная загрузка ЦП.
-   **`1`**: (Только для Linux) Использует `setitimer` для цикла сна в 1 мс.
-   **`2`**: (Только для Linux) Использует `poll` вместо устаревшей функции `select` для сна в 1 мс.
-   **`3`**: Оригинальная реализация движка (`NET_Sleep_Timeout`). Поведение не изменено.
-   **`4`**: (Новый) Более агрессивный буст. Процессор спит меньшее время (1 микросекунда), что приводит к более высокому FPS и отзывчивости. Доступно как для Linux, так и для Windows.
-   **`5`**: (Новый) Режим максимальной производительности. Поток сервера уступает управление (`yield`) вместо сна, стремясь к максимально возможному FPS. Это приведет к 100% загрузке одного ядра ЦП.

#### `-targetfps <значение>`

Это современная альтернатива `pingboost` и `sys_ticrate`. Он динамически подстраивает время сна сервера в реальном времени для поддержания желаемого FPS.

-   **Пример:** `-targetfps 1000`
-   Режим становится более агрессивным по мере падения производительности сервера, чтобы достичь целевого значения.
-   Для корректной работы этого режима **необходимо** установить `sys_ticrate` в `0` в вашем `server.cfg` или в командной строке (`+sys_ticrate 0`).

### Служебные параметры

#### `-conclearlog`

При наличии этот параметр будет очищать содержимое файла `qconsole.log` при каждом запуске сервера.

#### `-ignoresigint`

При использовании предотвращает завершение работы сервера по нажатию `CTRL+C` в консоли. Сервер можно будет закрыть только с помощью команды `quit` или `exit`.

#### `-pidfile <имя_файла>`

Записывает текущий идентификатор процесса (PID) сервера в указанный файл.
- **Пример:** `-pidfile "hlds.pid"`

## Сборка из исходного кода

Для самостоятельной компиляции проекта вам понадобятся:

-   [Git](https://git-scm.com/)
-   [CMake](https://cmake.org/) (версия 3.21 или выше)
-   Компилятор, совместимый с C++17 (например, Visual Studio 2022, GCC 9+, Clang 10+)

```bash
# 1. Клонируйте репозиторий
git clone https://github.com/your-repo/rehlds-m.git
cd rehlds-m

# 2. Сконфигурируйте проект с помощью CMake
cmake -B build

# 3. Соберите проект
cmake --build build --config Release
```
Скомпилированный бинарный файл будет находиться в директории `build/bin/`.

### Расширенные параметры сборки

#### Оптимизация под процессор сервера

Вы можете скомпилировать лаунчер с оптимизациями под конкретный процессор, на котором будет запущен сервер. Это активирует использование дополнительных наборов инструкций (помимо обязательных SSE4.2), что может дать прирост FPS.

Для включения этой опции используйте флаг `-DOPTIMIZE_FOR_CURRENT_CPU=ON` на втором шаге из примера выше:

```bash
# 2. Сконфигурируйте проект с помощью CMake с оптимизациями под процессор на текущей машине
cmake -B build -DOPTIMIZE_FOR_CURRENT_CPU=ON
```

**Внимание:** Используйте этот флаг, только если вы собираете лаунчер на той же машине, где он будет использоваться.

## F.A.Q.

-   **В: В консоли некорректно отображаются символы UTF-8.**
    -   **О:** Измените шрифт консоли на тот, который поддерживает символы UTF-8, например `Consolas` или `Lucida Console`.

-   **В: Сервер не запускается в Windows, жалуясь на отсутствие `msvcp140.dll`.**
    -   **О:** Вам необходимо установить [Microsoft Visual C++ Redistributable 2015-2022 (x86)](https://aka.ms/vs/17/release/vc_redist.x86.exe).

-   **В: В Windows 11 не отображается строка состояния.**
    -   **О:** Перейдите в Параметры -> Конфиденциальность и защита -> Для разработчиков -> Терминал и измените приложение терминала по умолчанию на "Узел консоли Windows".

## Лицензия

Этот проект лицензирован в соответствии с условиями файла `LICENSE`. Он также использует компоненты из Half-Life 1 SDK, который подлежит лицензионному соглашению от Valve Corporation.
